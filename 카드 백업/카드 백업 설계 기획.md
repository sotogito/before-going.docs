```
### 00시 스케줄러에서 해야 할 작업
1. **BASIC 백업**
    - `useDate = null` 인 미션들을 조회
    - 그대로 **깊은 복사** 후 `useDate = 어제(LocalDate.now().minusDays(1))` 로 저장
    - `isChecked` 상태는 그대로 복사
2. **보존기간 만료된 미션 삭제*
    - 기준일: `LocalDate.now().minusMonths(1)`
    - `useDate < 기준일` 인 모든 미션 삭제
    - 이렇게 하면 TODAY + 백업 BASIC 이 한 달치까지만 보존
3. DEFAULT BASIC 미션 리스트 체크 상태 false
```


---

즉, TODAY는 어차피 날짜의 개념이 있기 때문에 백업시 처리 안해줘도 됨
BASIC은 00시가 되면 깊은복사 후 useDate로 백업해주면됨

그리고 삭제하는 처리도 있는데

보존 기간은 한달, 사용자에게 보여지는 것은 앞뒤 2주

한달이 넘어간 데이터는 모두 삭제
백업 BASIC, TODAY 모두 다


### 아 근데 삭제한 시나리오는 백업 어떻게 하지 - 삭제 CRUD 확인해봐야함
삭제할때, 그 때 백업까지 삭제해버리는게 나은듯



대용량 데이터를 처리할때 그냥 for문으로 나누는지, 
그리고 batch update? 뭐 100개씩인가 나눠서 처리하는 방법 있지 않나




`OR (useDate IS NULL OR useDate = :date)` 는 인덱스 타기 어렵다.  
**두 쿼리로 쪼개서 가져와 합치는 것**이 보통 더 빠르다.

- `useDate IS NULL AND missionType=BASIC`
    
- `useDate = :date` (TODAY + 백업BASIC)


# 인덱스 권고

- `mission(use_date)` — 만료 삭제, 날짜 조회 가속.
    
- `mission(scenario_id, use_date)` — 특정 시나리오의 날짜별 조회.
    
- `(scenario_id, mission_type, use_date)` — 오늘/미래 TODAY, BASIC 조회 혼합 패턴 최적화.
    
- `scenario(member_id, id)` — `member_id`로 조인 필터링 빠르게.

```
@Modifying(clearAutomatically = true, flushAutomatically = true)  
@Query("""  
    UPDATE Mission m    SET m.isChecked = false    WHERE m.useDate IS NULL      AND m.missionType = 'BASIC'    """)  
int resetBasicIsChecked();  
  
@Modifying(clearAutomatically = true, flushAutomatically = true)  
@Query(value = """  
    INSERT INTO mission (      scenario_id, content, is_checked, mission_order, use_date, mission_type, created_at, updated_at    )    SELECT m.scenario_id, m.content, m.is_checked, m.mission_order, :yesterday, m.mission_type,           CURRENT_TIMESTAMP, CURRENT_TIMESTAMP    FROM mission m    WHERE m.use_date IS NULL      AND m.mission_type = 'BASIC'    """, nativeQuery = true)  
int bulkCloneBasicToYesterday(LocalDate yesterday);  
  
@Modifying(clearAutomatically = true, flushAutomatically = true)  
@Query("""  
    DELETE FROM Mission m    WHERE m.useDate IS NOT NULL      AND m.useDate < :expireBefore    """)  
int bulkDeleteExpired(LocalDate expireBefore);
```