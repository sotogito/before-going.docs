### 사용api
- 날씨 :  [기상청_단기예보 ((구)_동네예보) 조회서비스](https://www.data.go.kr/data/15084084/openapi.do) (단기예보)
- 미세먼지, UV : https://open-meteo.com/ (Air Quality)

미세먼지, UV도 공공데이터 포털에서 사용하려고 했으나, 미세먼지의 경우는 미세먼지 관측소 장소를 따로 측정해와야하고, UV의 경우는 좌표를 TM으로 한번 변환등 데이터를 가져오기위해서 중간에 1~2개의 변환 api가 필요하여 open-meta를 사용하였습니다. 또한 위도, 경도로 데이터를 다 가져오기 위해서는 다 활용 가능한 api사용하는이 간편하다고 생각. open-metio는 2024년에 공개된 기상 사이트같은데 괜찮은거같아요(open-meteo에 관한 글 짧게 적어줘)

기상청은 완전히 무료고. open-metaio도 무료이긴 하나 제한이 잇습니다. 저희 서비스에서는충분할 거 같아요
- 분 단위 제한 : 분당 600회
- 시간당 제한 : 시간당 5,000회
- 일일 한도 : 10,000회
- 월 한도 : 월 30만회
 기상청은 시크릿키가 발급되지만 open-meteo는 공용 url?을 사용하면 됨 아마 IP로 횟수를 제한하는듯함(이거 정확하게 설명좀)


### 처리 과정

일반적으로 기상청에서는 3시간마다 날씨 데이터를 업데이트합니다. 
기상청의 경우는 사용자의 위치, 요청 날짜가 같다면 3시간마다 재요청을 하면되고, 미세먼지와 UV는 15분마다 갱신되지만 3시간마다 갱신해도 충분다고 생각했습니다.
그래서 TimeSlot이라는 시간 상수를 사용합니다.
```
SLOT_00_03(0, 3),  
SLOT_03_06(3, 6),  
SLOT_06_09(6, 9),  
SLOT_09_12(9, 12),  
SLOT_12_15(12, 15),  
SLOT_15_18(15, 18),  
SLOT_18_21(18, 21),  
SLOT_21_24(21, 24);
```

1. 위도, 경도, 타겟 날짜 받기
2. 현재 시간으로 TimeSlot 계산
3. 캐시 확인 후 있으면 반환, 없으면 api 요청
- 오늘 날씨
	4. 날씨, 미세먼지, UV 결과를 시간별로 파싱(Map) + TimeSlot 범위 시간만 추출
	5. hash구조로 캐시에 업데이트 (3시:~ / 4시:~ / 5시:~)
	6. 요청 시간 기상 데이터 반환
- 미래 날씨(+3일)
	4. 날씨, 미세먼지, UV 결과를 시간별로 파싱(Map) + 00시~23시
	5. 각 기상 추출 (가장 최악의 기상 상태를 추출)
	6. string 구조로 캐시 업데이트
	7. 기상 데이터 반환

api 요청 최대 시간은 5초입니다
오늘 날씨는 3시간마다 가져오되, 사용자가 요청한 현재 시간의 기상을 반환합니다.
미래 날씨는 가장 최악의 기상 상태를 추출하여(비, 매우나쁨) 반환합니다.

### 캐시
만약 같은 사용자가, 또는 같은 반경에 있는 사용자가 데이터를 요청했을때 재요청하는 것은 시간이 오래 걸리기 때문에 사용자의 위도, 경도를 격자좌표로 변환하여 캐시에 저장합니다.
격자좌표는 반도를 5km × 5km 같은 일정 간격의 격자로 잘라서 각 지점마다 좌표값(`nx`, `ny`)을 지정해둡니다
처음에는 지역마다 나누고싶었지만 면적도 다르고 처리가 까다롭고 격자좌표가 더 정확하다고 생각했습니다.
격자좌표 계산 코드는 기상청에서 공식적으로 제공하는 변환 알고리즘 코드를 사용했습니다

redis key는 다음과 같습니다
- wx:today:51:131:2025-08-30:SLOT_00_03 : Hash
- wx:future:51:131:2025-08-31:SLOT_00_03 : String

재조회되는 상황은 조회타입+격자좌표+타겟날짜+타임슬롯이 같을 경우입니다.
wx:today(조회타입):51:131(격자좌표):2025-08-30(타겟날짜):SLOT_00_03(타임스롯)

오늘날씨 hash value구조는 다음과 같습니다.
```
1) "00"
2) "{\"weather\":\"RAIN\",\"findDust\":\"NORMAL\",\"uv\":\"VERY_LOW\"}"
3) "01"
4) "{\"weather\":\"RAIN\",\"findDust\":\"NORMAL\",\"uv\":\"VERY_LOW\"}"
5) "02"
6) "{\"weather\":\"RAIN\",\"findDust\":\"NORMAL\",\"uv\":\"VERY_LOW\"}"
```

TTL은 TimeSlot의 endTime입니다.
TimeSlot이 SLOT_00_03 이라면 시벽 3시에 캐시가 삭제되고 api는 재요청됩니다.

### 예외 처리
예외처리는 크게 두가치로 처리했는데요
- api접근에 실패했을 경우 : 클라이언트로 예외 던짐
- 그 외의 실패(해당 조회 기상 없음) : DEFAULT(없음) 반환

api에 접근에 실패하지 않는 이상 3 기상 정보가 다 null인 경우는 드물고, 하나가 없다고 예외를던지는건 오버같아서 일단 DEFAULT를 보내느 것으로 처리했습니다.

### fallback처리
기상청의 경우 정확하다는 장점이 있지만 요청이 불안정하다는 단점이 있는데요, 새벽시간대에 오류가 많은거 같습니다. 그래서 만약 기상청 api요청에 실패했을경우 open-meteo 기상api로 후처리를 추가했습니다

open-meteo 에서도 기상청을 제공합니다. 조회가 간편하다는 장점이 있지만 기상청 데이터를 가공해서 사용하는거라 정확도가 조금 떨어질수도 있다고 생각하여 후처리용으로 사용했습니다.
근데 이마저도 가끔은 오류가 나는부분이 있습니다 ㅜㅜ 미세먼지, UV에서는 안일어나는데 기상청의 문제인거같아요 이거는
. 
fallback되는 부분이 로깅을 추가해둬서 만약 서비스시 fallback이 많이 일어난다면 api를 변경해야할 거 같아요


---
### 첨삭본
### 사용 API
- 날씨 : [기상청 단기예보 조회서비스](https://www.data.go.kr/data/15084084/openapi.do?utm_source=chatgpt.com) (단기예보)
- 미세먼지, UV : [Open-Meteo Air Quality API](https://open-meteo.com/) (Air Quality)

미세먼자와 UV도 공공데이터포털에 국내 API를 사용하려고 했지만 미세먼지의 경우 관측소 좌표 기준으로만 제공되어 추가 처리(관측소 위치 매핑)가 필요하고,  UV는 TM 좌표 변환 등 중간 변환 API가 필요하여 사용하지 않았습니다.

Open-Meteo는 2024부터 공개된 무료 기상 API 플랫폼인데요. 위도/경도만으로 미세먼지, UV 일괄 조회가 가능해 단일 API로 처리하는 것이 간편하다고 판단했습니다.
직접 API 키를 발급받을 필요 없이 공용 엔드포인트(URL) 호출로 사용 가능하며, 내부적으로 요청 IP 기준으로 호출 횟수를 제한하는 거 같아요. 
- 분당 600회
- 시간당 5,000회
- 일일 10,000회
- 월 300,000회  
으로 서비스 규모상 충분할 거 같습니다.

### 처리 과정
- 기상청 단기예보는 3시간 주기로 데이터가 갱신됩니다.
- 미세먼지, UV는 15분마다 갱신되지만, 서비스 요구사항 상 3시간 단위로 조회해도 충분하다고 판단했습니다.

TimeSlot 상수를 정의하여 현재 시각을 기준으로 다음과 같이 구간을 나누었습니다.
```
SLOT_00_03(0, 3),  
SLOT_03_06(3, 6),  
SLOT_06_09(6, 9),  
SLOT_09_12(9, 12),  
SLOT_12_15(12, 15),  
SLOT_15_18(15, 18),  
SLOT_18_21(18, 21),  
SLOT_21_24(21, 24);
```

1. 위도, 경도, 타겟 날짜 요청
2. 현재 시간으로 TimeSlot 계산
3. 캐시 확인 후 있으면 반환, 없으면 API 요청

- 오늘 날씨  
4. . 날씨, 미세먼지, UV 결과를 시간별로 파싱(Map) 후 TimeSlot 범위만 추출  
5. Hash 구조로 캐시에 업데이트 (예: 3시:~, 4시: ~, 5시:~)  
6. 요청 시간 기상 데이터 반환

- 미래 날씨(+3일)  
4. 날씨, 미세먼지, UV 결과를 시간별로 파싱(Map) 후 00시~23시 추출  
5. 가장 최악의 기상 상태(비, 매우나쁨 등)를 선택  
6. String 구조로 캐시에 업데이트  
7. 기상 데이터 반환

API 요청 최대 시간은 5초입니다. 
swagger로 테스트해보면 3초정도 걸리는 거 같습니다.

오늘 날씨는 3시간마다 가져오되, 사용자가 요청한 현재 시간의 기상을 반환합니다.  
미래 날씨는 가장 최악의 기상 상태를 추출하여 반환합니다.

### 캐시
- 동일한 위도/경도 요청 시 매번 API 호출하는 것은 비효율적이므로, 위도/경도를 기상청 격자좌표로 변환 후 캐시에 저장합니다.
격자좌표는 한반도를 5km × 5km 격자로 나눈 좌표 체계(nx, ny)입니다.
- 캐시에 올라가는 격자좌표는 10km로 설정했습니다.

Redis Key 구조
- wx:today:51:131:2025-08-30:SLOT_00_03 : Hash
- wx:future:51:131:2025-08-31:SLOT_00_03 : String

wx:today(조회타입):51:131(격자좌표):2025-08-30(타겟날짜):SLOT_00_03(타임스롯)
캐시 조회 조건 = 조회타입 + 격자좌표 + 타겟날짜 + 타임슬롯이 동일할 경우

오늘날씨 hash value구조는 다음과 같습니다.
```
1) "00"
2) "{\"weather\":\"RAIN\",\"findDust\":\"NORMAL\",\"uv\":\"VERY_LOW\"}"
3) "01"
4) "{\"weather\":\"RAIN\",\"findDust\":\"NORMAL\",\"uv\":\"VERY_LOW\"}"
5) "02"
6) "{\"weather\":\"RAIN\",\"findDust\":\"NORMAL\",\"uv\":\"VERY_LOW\"}"
```

TTL은 TimeSlot의 endTime입니다.  
예: SLOT_00_03이면 오전 3시에 캐시 만료 후 API 재요청


### 예외 처리
- API 접근 실패 : 클라이언트로 예외 전송
- 데이터 누락 : DEFAULT(없음) 반환
api 요청에 실패하지않는 이상 3가지 기상 값이 모두 null인 경우는 거의 없고, 일부 값이 누락된 경우까지 예외로 처리하는 것은 과하다고 판단하여 DEFAULT 처리했습니다.

### fallback처리
기상청 API는 정확성이 높다는 장점이 있지만, 가끔 요청이 불안정하게 동작하는 단점이 있습니다. 특히 새벽 시간대에 오류가 자주 발생하는 거 같습니다.

때문에 후처리로 Open-Meteo KMA API를 사용했습니다.
Open-Meteo KMA 역시 기상청 데이터를 기반으로 하지만, 가공된 형태라 정확도는 약간 떨어질 수 있습니다. 
기본은 항상 기상청 API를 사용하고, 요청 실패 시에만 Open-Meteo 데이터를 가져오도록 했습니다.
다만 Open-Meteo에서도 간혹 오류가 발생하는 경우는 있습니다.

Fallback 발생 여부를 모두 로깅해두었고, 운영 중 Fallback이 과도하게 늘어나면 API를 변경해야할 거 같아요.