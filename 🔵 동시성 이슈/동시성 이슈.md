- 시나리오 순서 변경 - 잦은 요청 가능
- 시나리오 백업 문제

### 동시성 이슈 가능 지점과 영향

- 미션 자식 생성/삭제 동시성

- 상황: updateFutureBasicMission에서 동시에 체크 토글 시 둘 다 findByParentMissionIdAndUseDate가 비어있다고 보고 insert → 같은 (parentMissionId, useDate, missionType)로 중복 자식 생성 가능.

- 영향: 중복 데이터, 잘못된 체크상태 집계, 배치 시 삭제 누락.

- 권장: DB 유니크 제약 추가 (parent_mission_id, use_date, mission_type) + insert 시 유니크 예외 캐치(또는 upsert)로 단일성 보장.

- 자정 배치 vs 사용자 요청 경합

- 상황: runDailyBackupJob(복제/리셋/자식삭제) 실행 중 사용자가 체크 토글/오늘 미션 추가·삭제.

- 영향: 리셋/복제 타이밍에 따라 토글 유실, 자식 중복/삭제 누락, 일시적 불일치.

- 권장: 배치 수행 시간대 짧은 보호구간 설정(예: 00:00~00:01 UI 변경 차단), 또는 배치 전후 스냅샷 기반 처리/리트라이. 필요시 일 단위 “작업중 플래그”로 멱등 처리.

- 시나리오 순서 변경 동시성

- 상황: updateScenarioOrder가 prev/next 기반으로 계산. 동시 다중 요청 시 서로의 기준이 달라져 순서 충돌/재정렬 빈번.

- 영향: 순서 꼬임, 잦은 전체 재정렬.

- 권장: 순서 변경 시 대상 멤버의 시나리오 목록을 비관적 잠금으로 조회(PESSIMISTIC_WRITE)하거나 Scenario에 @Version 추가 후 낙관잠금 충돌 시 재시도. 또는 멤버별 분산락.

- 알림 캐시 리스너(@Async) 이벤트 순서/경합

- 상황: NotificationCacheListener가 @Async + AFTER_COMMIT. 동일 멤버/시나리오에 대해 onCreate/onUpdate/onDelete가 동시 처리될 수 있음.

- 영향: 캐시 갱신→삭제 순서 뒤바뀜, ETag 갱신 불일치, 불필요한 재빌드.

- 권장: 멤버 단위 실행 직렬화(키 기반 실행자), 혹은 @Async 제거(허용 지연 내). 캐시 조작 시 멱등성 강화(존재 안하면 무시, 마지막 쓰기 승리).

- Redis ETag 갱신 레이스

- 상황: handleRefreshCacheFromDatabase가 etag null 체크 후 리프레시. 동시 다발 시 중복 리프레시/ETag 교차 갱신.

- 영향: 불필요한 부하, ETag와 해시맵 데이터 시점 차이.

- 권장: etag 키에 대해 SET NX PX 기반 가벼운 락 또는 Lua 스크립트로 체크-세트 원자화. HSET + EXPIRE는 파이프라인으로 묶기.

- 만료 삭제 배치의 중복 실행/클러스터 동시 실행

- 상황: bulkDeleteExpired 루프는 단일 인스턴스 가정. 멀티 인스턴스 배포 시 동시 실행 가능.

- 영향: 락 경합, 중복 작업, 불필요한 부하.

- 권장: ShedLock/DB-락/리더 선출로 스케줄러 단일화.

- 삭제 트랜잭션 중 조회

- 상황: deleteScenarioWithAllMissions 실행(미션→알림→시나리오 삭제)과 동시 조회.

- 영향: 조회 타이밍에 따라 일부 엔티티만 보이는 일시 불일치 가능. 기본 격리수준(READ_COMMITTED)에서 허용되는 현상.

- 권장: 중요 API는 “존재 검증 후 캐시 응답”으로 일관성 개선. 강한 일관성 필요 구간은 적절히 잠금/재시도.

### 빠른 개선 체크리스트

- DB 제약 추가: 미션 유니크

- mission: UNIQUE (parent_mission_id, use_date, mission_type)

- 락/버전

- Scenario, Mission에 @Version 도입(낙관잠금) 또는 시나리오 재정렬 시 비관잠금/분산락.

- 배치 단일화/보호

- ShedLock 적용, 자정 ±1분 UI 쓰기 차단 또는 서버 측 가드.

- 캐시 처리 직렬화

- 멤버별 큐잉/락, ETag 갱신 원자화(SETNX/Lua), 파이프라인 사용.

필요하면 위 항목들 중 우선순위로 유니크 제약과 시나리오 순서 처리 잠금부터 적용할 수 있게 마이그레이션/코드 예시 드릴게요.
